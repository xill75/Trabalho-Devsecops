// routes/malwareRoutes.js
const express = require('express');
const router = express.Router();
const db = require('../database/db.js');

const json2csv = require('json2csv').parse; // Importa a biblioteca json2csv

// Rota para criar um malware
router.post('/', (req, res) => {
    const { name, description } = req.body;
    db.query('INSERT INTO malwares (m_name, m_description) VALUES (?, ?)', [name, description], (err, result) => {
        if (err) return res.status(500);
        res.status(201).send({ id: result.insertId, name, description });
    });
});

// Rota para listar todos os malwares
router.get('/', (req, res) => {
    db.query('SELECT * FROM malwares', (err, results) => {
        if (err) return res.status(500);
        res.send(results);
    });
});

// Rota para editar um malware
router.put('/:id', (req, res) => {
    const { id } = req.params;
    const { name, description } = req.body;
    db.query('UPDATE malwares SET m_name = ?, m_description = ? WHERE id = ?', [name, description, id], (err) => {
        if (err) return res.status(500);
        res.send({ id, name, description });
    });
});

// Rota para excluir um malware
router.delete('/:id', (req, res) => {
    const { id } = req.params;
    db.query('DELETE FROM malwares WHERE id = ?', [id], (err) => {
        if (err) return res.status(500);
        res.send({ message: 'Malware excluído com sucesso' });
    });
});

// rota para exportar malwares em CSV
router.get('/dowload', (req, res) => {
    db.query('SELECT * FROM malwares', (err, results) => {
        if (err) return res.status(500).send('Erro ao consultar os malwares');
        
        // Converte os resultados para CSV
        const csv = json2csv(results);
        
        // Define o cabeçalho para indicar que é um arquivo CSV
        res.header('Content-Type', 'text/csv');
        res.attachment('malwares.csv');
        res.send(csv);
    });
});


module.exports = router;
